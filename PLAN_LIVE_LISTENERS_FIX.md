# –ü–õ–ê–ù: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã "–ñ–∏–≤—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏"

## –¢–ï–ö–£–©–ò–ï –ü–†–û–ë–õ–ï–ú–´
1. ‚ùå –ù–µ –≤–∏–¥–Ω–æ, –∫—Ç–æ –¥–æ—Å—Ç—É–ø–µ–Ω –∫–∞–∫ —Å–ª—É—à–∞—Ç–µ–ª—å
2. ‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑ –≤—ã–±–æ—Ä–∞
3. ‚ùå –°–µ—Å—Å–∏—è –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å—Å—è —Å —Å–∞–º–∏–º —Å–æ–±–æ–π
4. ‚ùå –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
5. ‚ùå –°–µ—Å—Å–∏—è –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —É –æ–±–æ–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

## –¢–†–ï–ë–£–ï–ú–ê–Ø –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨

### 1. –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
**–ß–¢–û:** –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∞–∫—Ç–∏–≤–Ω—ã –∫–∞–∫ —Å–ª—É—à–∞—Ç–µ–ª–∏
**–ì–î–ï:** –í —Ä–∞–∑–¥–µ–ª–µ "–ñ–∏–≤—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏"

**UI –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:**
```
–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üë§ Username1                ‚îÇ
‚îÇ    –û–Ω–ª–∞–π–Ω ‚Ä¢ –≠–º–ø–∞—Ç           ‚îÇ
‚îÇ    [–ù–∞—á–∞—Ç—å —á–∞—Ç]             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üë§ Username2                ‚îÇ
‚îÇ    –û–Ω–ª–∞–π–Ω ‚Ä¢ –û–ø—Ç–∏–º–∏—Å—Ç        ‚îÇ
‚îÇ    [–ù–∞—á–∞—Ç—å —á–∞—Ç]             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Å—Å–∏–∏

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A (–Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –ø–æ–º–æ—â–∏)
              ‚Üì
    [–í—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—à–∞—Ç–µ–ª—è B]
              ‚Üì
    Socket: create_conversation
              ‚Üì
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ Backend ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                  ‚îÇ
    ‚Üì                  ‚Üì
–£ A –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è    –£ B –≤—Å–ø–ª—ã–≤–∞–µ—Ç
–æ–∫–Ω–æ —á–∞—Ç–∞          —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                   + –æ–∫–Ω–æ —á–∞—Ç–∞
```

## –ù–ï–û–ë–•–û–î–ò–ú–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### BACKEND

#### 1. –ù–æ–≤—ã–π endpoint: GET /api/ears/list
**–§–∞–π–ª:** `routes/live-ears.js`
**–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 50:**

```javascript
// –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
router.get('/ears/list', authenticateToken, async (req, res) => {
  try {
    const listeners = await pool.query(`
      SELECT u.id, u.username, e.psychotype, e.registered_at
      FROM ear_registrations e
      JOIN users u ON e.user_id = u.id
      WHERE e.user_id != $1
      AND e.registered_at > NOW() - INTERVAL '1 hour'
      ORDER BY e.registered_at DESC
    `, [req.user.id]); // –ò—Å–∫–ª—é—á–∞–µ–º —Å–∞–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!

    res.json({
      listeners: listeners.rows.map(l => ({
        id: l.id,
        username: l.username,
        psychotype: l.psychotype || 'empath',
        online: true
      }))
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π:', error);
    res.status(500).json({ error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});
```

#### 2. –ò–∑–º–µ–Ω–∏—Ç—å endpoint: POST /conversations/find
**–§–∞–π–ª:** `routes/live-ears.js` —Å—Ç—Ä–æ–∫–∞ 61
**–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞:**

```javascript
router.post('/conversations/create', authenticateToken, async (req, res) => {
  try {
    const { listenerId } = req.body;
    
    if (!listenerId) {
      return res.status(400).json({ error: '–¢—Ä–µ–±—É–µ—Ç—Å—è ID —Å–ª—É—à–∞—Ç–µ–ª—è' });
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é —Å —Å–æ–±–æ–π
    if (listenerId == req.user.id) {
      return res.status(400).json({ error: '–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é —Å —Å–∞–º–∏–º —Å–æ–±–æ–π' });
    }

    const result = await pool.query(`
      INSERT INTO conversations (user_id, ear_id, started_at, status)
      VALUES ($1, $2, NOW(), 'active')
      RETURNING id, user_id, ear_id, started_at
    `, [req.user.id, listenerId]);

    const conversation = result.rows[0];

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–ª—É—à–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Socket
    SocketService.notifyNewConversation(listenerId, {
      conversation_id: conversation.id,
      requester: {
        id: req.user.id,
        username: req.user.username
      }
    });

    res.json({
      message: '–°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞',
      conversation_id: conversation.id
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
    res.status(500).json({ error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});
```

#### 3. Socket —Å–æ–±—ã—Ç–∏—è
**–§–∞–π–ª:** `services/socket-service.js`
**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥:**

```javascript
static notifyNewConversation(listenerId, data) {
  const listenerSocket = this.getUserSocket(listenerId);
  if (listenerSocket) {
    listenerSocket.emit('new_conversation_request', data);
  }
}
```

### FRONTEND

#### 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π
**–§–∞–π–ª:** `public/js/live-listeners.js`
**–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é:**

```javascript
window.loadAvailableListeners = async function() {
    try {
        const response = await fetch('/api/ears/list', {
            headers: {
                'Authorization': 'Bearer ' + window.currentToken
            }
        });
        const data = await response.json();
        
        if (response.ok) {
            displayListenersList(data.listeners);
        }
    } catch (error) {
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª—É—à–∞—Ç–µ–ª–µ–π: ' + error.message);
    }
};

function displayListenersList(listeners) {
    const container = document.getElementById('listenersListContainer');
    if (!container) return;
    
    if (listeners.length === 0) {
        container.innerHTML = '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π</p>';
        return;
    }
    
    container.innerHTML = listeners.map(listener => `
        <div class="listener-card">
            <div class="listener-info">
                <strong>üë§ ${listener.username}</strong>
                <div>–û–Ω–ª–∞–π–Ω ‚Ä¢ ${listener.psychotype}</div>
            </div>
            <button class="btn btn-primary" onclick="startConversationWith(${listener.id}, '${listener.username}')">
                –ù–∞—á–∞—Ç—å —á–∞—Ç
            </button>
        </div>
    `).join('');
}
```

#### 2. –ù–∞—á–∞—Ç—å —Å–µ—Å—Å–∏—é —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Å–ª—É—à–∞—Ç–µ–ª–µ–º
**–ò–∑–º–µ–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `findLiveEar`:**

```javascript
window.startConversationWith = async function(listenerId, listenerName) {
    try {
        const response = await fetch('/api/conversations/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + window.currentToken
            },
            body: JSON.stringify({ listenerId })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            window.currentConversationId = data.conversation_id;
            window.currentListenerName = listenerName;
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–∞—Ç–∞
            document.getElementById('conversationSection').classList.remove('hidden');
            document.getElementById('conversationPartner').textContent = listenerName;
            
            showSuccess(`–°–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞ —Å ${listenerName}`);
            loadConversationMessages();
        } else {
            showError('–û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (error) {
        showError('–û—à–∏–±–∫–∞: ' + error.message);
    }
};
```

#### 3. Socket –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–ª—É—à–∞—Ç–µ–ª—è
**–î–æ–±–∞–≤–∏—Ç—å –≤ setupSocketListeners:**

```javascript
window.socket.on('new_conversation_request', (data) => {
    window.currentConversationId = data.conversation_id;
    window.currentRequesterName = data.requester.username;
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
    showSuccess(`–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç ${data.requester.username}`);
    
    document.getElementById('conversationSection').classList.remove('hidden');
    document.getElementById('conversationPartner').textContent = data.requester.username;
    
    loadConversationMessages();
});
```

#### 4. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
**–ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤ sendConversationMessage:**

–°–æ–æ–±—â–µ–Ω–∏—è —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 77-82:
```javascript
appendMessage({
    sender_id: window.currentUser.id,
    message_text: message,
    sent_at: new Date().toISOString()
}, true);
```

–ù–û –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –æ–Ω–æ —Ç–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Socket –≤—Ç–æ—Ä–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É!

### HTML –ò–ó–ú–ï–ù–ï–ù–ò–Ø

**–§–∞–π–ª:** `public/index.html`
**–ó–∞–º–µ–Ω–∏—Ç—å —Ä–∞–∑–¥–µ–ª Live Listeners (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 150):**

```html
<div id="liveListenersView" class="view-section hidden">
    <div class="content-header">
        <h3><i class="fas fa-headphones"></i> –ñ–∏–≤—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏</h3>
    </div>

    <div class="content-body">
        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div style="text-align: center; margin-bottom: 30px;">
            <button class="btn btn-primary" onclick="loadAvailableListeners()">
                <i class="fas fa-search"></i> –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
            </button>
            <button class="btn btn-secondary" id="earToggleButton" onclick="toggleEarRegistration()">
                <i class="fas fa-ear-listen"></i> –°—Ç–∞—Ç—å —Å–ª—É—à–∞—Ç–µ–ª–µ–º
            </button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π -->
        <div id="listenersListContainer" style="margin-bottom: 30px;">
            <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è -->
        <div id="conversationSection" class="hidden">
            <div style="background: #f0f0f0; padding: 10px; margin-bottom: 10px; border-radius: 8px;">
                <strong>–†–∞–∑–≥–æ–≤–æ—Ä —Å:</strong> <span id="conversationPartner">...</span>
            </div>
            
            <div id="conversationMessages" class="chat-messages" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"></div>

            <div class="chat-controls">
                <input type="text" id="conversationMessageInput" class="form-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="btn btn-icon btn-primary" onclick="sendConversationMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button class="btn btn-secondary" onclick="closeConversation()">
                    –ó–∞–≤–µ—Ä—à–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>
```

## –ü–û–†–Ø–î–û–ö –í–ù–ï–î–†–ï–ù–ò–Ø

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å endpoint `/api/ears/list` –≤ backend
2. ‚úÖ –ò–∑–º–µ–Ω–∏—Ç—å `/conversations/find` –Ω–∞ `/conversations/create` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º listenerId  
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å Socket —Å–æ–±—ã—Ç–∏–µ `new_conversation_request`
4. ‚úÖ –°–æ–∑–¥–∞—Ç—å UI –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π
5. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `startConversationWith()`
6. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å Socket –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É —Å–ª—É—à–∞—Ç–µ–ª—è
7. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å HTML –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

## –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ —Å–ª—É—à–∞—Ç–µ–ª—å
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B –∑–∞—Ö–æ–¥–∏—Ç –≤ "–ñ–∏–≤—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏"
3. B –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π"
4. B –≤–∏–¥–∏—Ç A –≤ —Å–ø–∏—Å–∫–µ
5. B –Ω–∞–∂–∏–º–∞–µ—Ç "–ù–∞—á–∞—Ç—å —á–∞—Ç" —Ä—è–¥–æ–º —Å A
6. –£ B –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –æ–∫–Ω–æ —á–∞—Ç–∞
7. –£ A –≤—Å–ø–ª—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–∞—Ç
8. –û–±–∞ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
9. –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—è–≤–ª—è—é—Ç—Å—è —É –æ–±–æ–∏—Ö

## CSS –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Å–ª—É—à–∞—Ç–µ–ª–µ–π

**–î–æ–±–∞–≤–∏—Ç—å –≤ `public/css/style.css`:**

```css
.listener-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.listener-info {
    flex-grow: 1;
}

.listener-info strong {
    display: block;
    margin-bottom: 5px;
}

.listener-info div {
    font-size: 14px;
    color: #666;
}
```

–≠—Ç–æ –ø–æ–ª–Ω—ã–π –ø–ª–∞–Ω! –ù—É–∂–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ –ø–æ—Ä—è–¥–∫—É.
