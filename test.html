<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† –£—à–∏ - AI –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Streaming</title>
    <style>
        /* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ */
        
        .model-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-size: 12px;
        }
        
        .streaming-active {
            border: 2px solid #4caf50;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { border-color: #4caf50; }
            50% { border-color: #81c784; }
            100% { border-color: #4caf50; }
        }
        
        .stream-indicator {
            display: none;
            color: #4caf50;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† –£—à–∏ - AI –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ PRO</h1>
            <p>–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ AI –º–æ–¥–µ–ª–∏ —Å –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–µ–π</p>
        </div>
        
        <div class="content">
            <div class="control-group">
                <h3>üé≠ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞</h3>
                
                <div class="control-row">
                    <label for="provider">AI –ü—Ä–æ–≤–∞–π–¥–µ—Ä:</label>
                    <select id="provider" onchange="loadModels()">
                        <!-- –û–ø—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </select>
                </div>
                
                <div class="control-row">
                    <label for="model">–ú–æ–¥–µ–ª—å:</label>
                    <select id="model">
                        <!-- –û–ø—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </select>
                </div>
                
                <div class="control-row">
                    <label for="psychotype">–ü—Å–∏—Ö–æ—Ç–∏–ø:</label>
                    <select id="psychotype">
                        <option value="empath">–≠–º–ø–∞—Ç ü§ó</option>
                        <option value="optimist">–û–ø—Ç–∏–º–∏—Å—Ç üåü</option>
                        <option value="rational">–†–∞—Ü–∏–æ–Ω–∞–ª–∏—Å—Ç üß†</option>
                    </select>
                </div>
                
                <div class="control-row">
                    <label for="messageInput">–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                    <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                </div>

                <div class="control-row">
                    <label>
                        <input type="checkbox" id="useStreaming" checked>
                        –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫–æ–≤—É—é –ø–µ—Ä–µ–¥–∞—á—É (–±—ã—Å—Ç—Ä–µ–µ)
                    </label>
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn-primary" onclick="testAIChat()">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ò–ò</button>
                <button class="btn-secondary" onclick="loadProviders()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã</button>
            </div>
            
            <div id="typingIndicator" class="typing">
                ‚è≥ –ò–ò –ø–µ—á–∞—Ç–∞–µ—Ç –æ—Ç–≤–µ—Ç... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.
            </div>

            <div id="streamIndicator" class="stream-indicator">
                üîÑ –ü–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∞–∫—Ç–∏–≤–Ω–∞...
            </div>
            
            <div class="result-area">
                <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
                <div id="chatResult"></div>
            </div>
        </div>
    </div>

    <script>
        let availableProviders = [];
        let availableModels = {};

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∏ –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', loadProviders);

        async function loadProviders() {
            try {
                const response = await fetch('http://localhost:3000/api/providers');
                availableProviders = await response.json();
                
                const providerSelect = document.getElementById('provider');
                providerSelect.innerHTML = '';
                
                availableProviders.forEach(provider => {
                    const option = document.createElement('option');
                    option.value = provider.id;
                    option.textContent = `${provider.name} ${provider.enabled ? '‚úÖ' : '‚ùå'}`;
                    option.disabled = !provider.enabled;
                    providerSelect.appendChild(option);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–æ–¥–µ–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
                    if (provider.enabled) {
                        availableModels[provider.id] = provider.models;
                    }
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
                loadModels();
                
                console.log('‚úÖ –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∏ –º–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', availableProviders);
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤: ' + error.message);
            }
        }

        function loadModels() {
            const provider = document.getElementById('provider').value;
            const modelSelect = document.getElementById('model');
            modelSelect.innerHTML = '';
            
            if (availableModels[provider]) {
                Object.entries(availableModels[provider]).forEach(([modelKey, modelInfo]) => {
                    const option = document.createElement('option');
                    option.value = modelKey;
                    option.textContent = `${modelInfo.name} (${modelInfo.context} tokens)`;
                    modelSelect.appendChild(option);
                });
            }
        }

        async function testAIChat() {
            const psychotype = document.getElementById('psychotype').value;
            const provider = document.getElementById('provider').value;
            const model = document.getElementById('model').value;
            const message = document.getElementById('messageInput').value;
            const useStreaming = document.getElementById('useStreaming').checked;
            
            if (!message) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }
            
            if (useStreaming) {
                await testAIChatStream(psychotype, provider, model, message);
            } else {
                await testAIChatRegular(psychotype, provider, model, message);
            }
        }

        async function testAIChatRegular(psychotype, provider, model, message) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
            document.getElementById('typingIndicator').style.display = 'block';
            document.getElementById('streamIndicator').style.display = 'none';
            document.getElementById('chatResult').innerHTML = '';
            
            const clientStartTime = Date.now();
            
            try {
                const response = await fetch('http://localhost:3000/api/chat/ai', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        message: message,
                        psychotype: psychotype,
                        provider: provider,
                        model: model
                    })
                });
                
                const clientEndTime = Date.now();
                const clientTime = clientEndTime - clientStartTime;
                
                if (!response.ok) {
                    throw new Error(`HTTP –æ—à–∏–±–∫–∞! —Å—Ç–∞—Ç—É—Å: ${response.status}`);
                }
                
                const data = await response.json();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                document.getElementById('typingIndicator').style.display = 'none';
                
                if (data.success) {
                    displayResult(data, clientTime, false);
                } else {
                    document.getElementById('chatResult').innerHTML = 
                        `<div class="result error">‚ùå –û—à–∏–±–∫–∞: ${data.error}</div>`;
                }
                    
            } catch (error) {
                document.getElementById('typingIndicator').style.display = 'none';
                document.getElementById('chatResult').innerHTML = 
                    `<div class="result error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}</div>`;
            }
        }

        async function testAIChatStream(psychotype, provider, model, message) {
            document.getElementById('typingIndicator').style.display = 'none';
            document.getElementById('streamIndicator').style.display = 'block';
            document.getElementById('chatResult').innerHTML = 
                '<div class="result streaming-active" id="streamResult">üí≠ –û—Ç–≤–µ—Ç: <span id="streamText"></span></div>';
            
            const streamStartTime = Date.now();
            const streamText = document.getElementById('streamText');
            
            try {
                const response = await fetch('http://localhost:3000/api/chat/ai/stream', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        message: message,
                        psychotype: psychotype,
                        provider: provider,
                        model: model
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP –æ—à–∏–±–∫–∞! —Å—Ç–∞—Ç—É—Å: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    fullResponse += chunk;
                    streamText.textContent = fullResponse;
                    
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É
                    streamText.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                
                const streamEndTime = Date.now();
                const streamTime = streamEndTime - streamStartTime;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏
                const timingHTML = `
                    <div class="timing">
                        <strong>‚è±Ô∏è –í—Ä–µ–º—è –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏:</strong>
                        <div class="timing-grid">
                            <div class="timing-item">
                                <div class="timing-value">${streamTime}ms</div>
                                <div>–û–±—â–µ–µ –≤—Ä–µ–º—è</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('streamResult').innerHTML += timingHTML;
                
            } catch (error) {
                document.getElementById('chatResult').innerHTML = 
                    `<div class="result error">‚ùå –û—à–∏–±–∫–∞ –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏: ${error.message}</div>`;
            } finally {
                document.getElementById('streamIndicator').style.display = 'none';
            }
        }

        function displayResult(data, clientTime, isStreaming) {
            const streamingBadge = isStreaming ? '<span class="provider-badge" style="background:#4caf50">STREAM</span>' : '';
            
            let resultHTML = `
                <div class="result success">
                    <div style="margin-bottom: 15px;">
                        <strong>üí≠ –û—Ç–≤–µ—Ç:</strong> ${data.response}
                    </div>
                    <div style="color: #666; font-size: 14px;">
                        <span class="psychotype-badge">${data.psychotype}</span>
                        <span class="provider-badge">${data.provider}</span>
                        <span class="provider-badge" style="background:#ff9800">${data.model}</span>
                        ${streamingBadge}
                    </div>
                </div>
            `;
            
            if (!isStreaming) {
                resultHTML += `
                    <div class="timing">
                        <strong>‚è±Ô∏è –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</strong>
                        <div class="timing-grid">
                            <div class="timing-item">
                                <div class="timing-value">${data.timing.api_response_time}ms</div>
                                <div>API</div>
                            </div>
                            <div class="timing-item">
                                <div class="timing-value">${data.timing.total_time}ms</div>
                                <div>–°–µ—Ä–≤–µ—Ä</div>
                            </div>
                            <div class="timing-item">
                                <div class="timing-value">${clientTime}ms</div>
                                <div>–ö–ª–∏–µ–Ω—Ç</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('chatResult').innerHTML = resultHTML;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('messageInput').focus();
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                testAIChat();
            }
        });
    </script>
</body>
</html>