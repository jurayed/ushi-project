// public/js/ai-chat.js
import { showError, showSuccess, showInfo } from './ui.js';

let availableProviders = [];
let availableModels = {};

// ╨У╨╗╨╛╨▒╨░╨╗╤М╨╜╤Л╨╡ ╤Д╤Г╨╜╨║╤Ж╨╕╨╕ AI ╤З╨░╤В╨░
window.testAIChat = async function() {
    if (!window.currentToken) {
        showError('╨б╨╜╨░╤З╨░╨╗╨░ ╨▓╨╛╨╣╨┤╨╕╤В╨╡ ╨▓ ╤Б╨╕╤Б╤В╨╡╨╝╤Г');
        return;
    }

    const psychotype = document.getElementById('psychotype')?.value;
    const provider = document.getElementById('provider')?.value;
    const model = document.getElementById('model')?.value;
    const message = document.getElementById('messageInput')?.value.trim();
    const useStreaming = document.getElementById('useStreaming')?.checked;

    if (!message) {
        showError('╨Я╨╛╨╢╨░╨╗╤Г╨╣╤Б╤В╨░, ╨▓╨▓╨╡╨┤╨╕╤В╨╡ ╤Б╨╛╨╛╨▒╤Й╨╡╨╜╨╕╨╡');
        return;
    }

    if (!provider || !model) {
        showError('╨Т╤Л╨▒╨╡╤А╨╕╤В╨╡ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨░ ╨╕ ╨╝╨╛╨┤╨╡╨╗╤М');
        return;
    }

    // ╨Ю╤З╨╕╤Й╨░╨╡╨╝ ╨┐╨╛╨╗╨╡ ╨▓╨▓╨╛╨┤╨░ ╨┐╨╛╤Б╨╗╨╡ ╨╛╤В╨┐╤А╨░╨▓╨║╨╕
    document.getElementById('messageInput').value = '';

    if (useStreaming) {
        await testAIChatStream(psychotype, provider, model, message);
    } else {
        await testAIChatRegular(psychotype, provider, model, message);
    }
};

window.loadProviders = async function() {
    try {
        console.log('ЁЯФД ╨Ч╨░╨│╤А╤Г╨╖╨║╨░ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨╛╨▓...');
        
        showInfo('╨Ч╨░╨│╤А╤Г╨╖╨║╨░ ╤Б╨┐╨╕╤Б╨║╨░ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨╛╨▓...');
        
        const response = await fetch('/api/providers');
        
        if (!response.ok) {
            throw new Error(`HTTP ╨╛╤И╨╕╨▒╨║╨░! ╤Б╤В╨░╤В╤Г╤Б: ${response.status}`);
        }
        
        availableProviders = await response.json();
        
        const providerSelect = document.getElementById('provider');
        if (!providerSelect) {
            console.warn('╨н╨╗╨╡╨╝╨╡╨╜╤В provider ╨╜╨╡ ╨╜╨░╨╣╨┤╨╡╨╜');
            return;
        }
        
        providerSelect.innerHTML = '<option value="">╨Т╤Л╨▒╨╡╤А╨╕╤В╨╡ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨░</option>';
        
        let enabledCount = 0;
        availableProviders.forEach(provider => {
            const option = document.createElement('option');
            option.value = provider.id;
            option.textContent = `${provider.name} ${provider.enabled ? 'тЬЕ' : 'тЭМ'}`;
            option.disabled = !provider.enabled;
            providerSelect.appendChild(option);
            
            if (provider.enabled) {
                availableModels[provider.id] = provider.models;
                enabledCount++;
            }
        });
        
        // ╨Р╨▓╤В╨╛╨╝╨░╤В╨╕╤З╨╡╤Б╨║╨╕ ╨▓╤Л╨▒╨╕╤А╨░╨╡╨╝ ╨┐╨╡╤А╨▓╤Л╨╣ ╨┤╨╛╤Б╤В╤Г╨┐╨╜╤Л╨╣ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А
        const firstEnabledProvider = availableProviders.find(p => p.enabled);
        if (firstEnabledProvider) {
            providerSelect.value = firstEnabledProvider.id;
            loadModels();
        }
        
        console.log('тЬЕ ╨Я╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╤Л ╨╖╨░╨│╤А╤Г╨╢╨╡╨╜╤Л:', availableProviders);
        showSuccess(`╨Ч╨░╨│╤А╤Г╨╢╨╡╨╜╨╛ ${availableProviders.length} ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨╛╨▓ (${enabledCount} ╨┤╨╛╤Б╤В╤Г╨┐╨╜╨╛)`);
        
    } catch (error) {
        console.error('тЭМ ╨Ю╤И╨╕╨▒╨║╨░ ╨╖╨░╨│╤А╤Г╨╖╨║╨╕ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨╛╨▓:', error);
        showError('╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╖╨░╨│╤А╤Г╨╖╨╕╤В╤М ╤Б╨┐╨╕╤Б╨╛╨║ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨╛╨▓: ' + error.message);
        
        // ╨Я╨╛╨║╨░╨╖╤Л╨▓╨░╨╡╨╝ fallback ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╤Л ╨┐╤А╨╕ ╨╛╤И╨╕╨▒╨║╨╡
        showFallbackProviders();
    }
};

window.loadModels = function() {
    const provider = document.getElementById('provider')?.value;
    const modelSelect = document.getElementById('model');
    
    if (!modelSelect || !provider) {
        console.warn('╨н╨╗╨╡╨╝╨╡╨╜╤В model ╨╕╨╗╨╕ provider ╨╜╨╡ ╨╜╨░╨╣╨┤╨╡╨╜');
        return;
    }
    
    modelSelect.innerHTML = '<option value="">╨Т╤Л╨▒╨╡╤А╨╕╤В╨╡ ╨╝╨╛╨┤╨╡╨╗╤М</option>';
    
    if (availableModels[provider]) {
        Object.entries(availableModels[provider]).forEach(([modelKey, modelInfo]) => {
            const option = document.createElement('option');
            option.value = modelKey;
            option.textContent = `${modelInfo.name} (${modelInfo.context} tokens) - ${modelInfo.price || '╤Ж╨╡╨╜╨░ ╨╜╨╡ ╤Г╨║╨░╨╖╨░╨╜╨░'}`;
            modelSelect.appendChild(option);
        });
        
        // ╨Р╨▓╤В╨╛╨╝╨░╤В╨╕╤З╨╡╤Б╨║╨╕ ╨▓╤Л╨▒╨╕╤А╨░╨╡╨╝ ╨┐╨╡╤А╨▓╤Г╤О ╨╝╨╛╨┤╨╡╨╗╤М
        const firstModel = Object.keys(availableModels[provider])[0];
        if (firstModel) {
            modelSelect.value = firstModel;
        }
        
        console.log(`тЬЕ ╨Ь╨╛╨┤╨╡╨╗╨╕ ╨╖╨░╨│╤А╤Г╨╢╨╡╨╜╤Л ╨┤╨╗╤П ${provider}:`, Object.keys(availableModels[provider]));
    } else {
        console.warn('╨Ь╨╛╨┤╨╡╨╗╨╕ ╨╜╨╡ ╨╜╨░╨╣╨┤╨╡╨╜╤Л ╨┤╨╗╤П ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨░:', provider);
        showError('╨Ь╨╛╨┤╨╡╨╗╨╕ ╨╜╨╡ ╨╜╨░╨╣╨┤╨╡╨╜╤Л ╨┤╨╗╤П ╨▓╤Л╨▒╤А╨░╨╜╨╜╨╛╨│╨╛ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨░');
    }
};

// Fallback ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╤Л ╨┐╤А╨╕ ╨╛╤И╨╕╨▒╨║╨╡ ╨╖╨░╨│╤А╤Г╨╖╨║╨╕
function showFallbackProviders() {
    const providerSelect = document.getElementById('provider');
    if (!providerSelect) return;
    
    providerSelect.innerHTML = `
        <option value="deepseek">DeepSeek тЬЕ</option>
        <option value="openai">OpenAI тЬЕ</option>
        <option value="gemini">Google Gemini тЬЕ</option>
    `;
    
    const modelSelect = document.getElementById('model');
    if (modelSelect) {
        modelSelect.innerHTML = `
            <option value="deepseek-chat">DeepSeek Chat (32768 tokens) - $0.14/1M input</option>
            <option value="gpt-4-turbo-preview">GPT-4 Turbo (128000 tokens) - $10/1M input</option>
            <option value="gemini-2.0-flash">Gemini 2.0 Flash (1000000 tokens) - ╨С╨╡╤Б╨┐╨╗╨░╤В╨╜╨╛ (╨▒╤Л╤Б╤В╤А╨░╤П)</option>
        `;
    }
    
    console.log('ЁЯФД ╨Ш╤Б╨┐╨╛╨╗╤М╨╖╤Г╤О╤В╤Б╤П fallback ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╤Л');
    showInfo('╨Ш╤Б╨┐╨╛╨╗╤М╨╖╤Г╤О╤В╤Б╤П ╤А╨╡╨╖╨╡╤А╨▓╨╜╤Л╨╡ ╨╜╨░╤Б╤В╤А╨╛╨╣╨║╨╕ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨╛╨▓');
}

// ╨Т╨╜╤Г╤В╤А╨╡╨╜╨╜╨╕╨╡ ╤Д╤Г╨╜╨║╤Ж╨╕╨╕
async function testAIChatRegular(psychotype, provider, model, message) {
    const typingIndicator = document.getElementById('typingIndicator');
    const streamIndicator = document.getElementById('streamIndicator');
    const chatResult = document.getElementById('chatResult');
    
    if (typingIndicator) typingIndicator.style.display = 'block';
    if (streamIndicator) streamIndicator.style.display = 'none';
    if (chatResult) chatResult.innerHTML = '';
    
    const clientStartTime = Date.now();
    
    try {
        console.log('ЁЯУд ╨Ю╤В╨┐╤А╨░╨▓╨║╨░ ╨╖╨░╨┐╤А╨╛╤Б╨░ ╨║ AI...', { psychotype, provider, model, message });
        
        const response = await fetch('/api/chat/ai', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + window.currentToken
            },
            body: JSON.stringify({
                message: message,
                psychotype: psychotype,
                provider: provider,
                model: model
            })
        });
        
        const clientEndTime = Date.now();
        const clientTime = clientEndTime - clientStartTime;
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `HTTP ╨╛╤И╨╕╨▒╨║╨░! ╤Б╤В╨░╤В╤Г╤Б: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (typingIndicator) typingIndicator.style.display = 'none';
        
        if (data.success) {
            displayRegularResult(data, clientTime);
            showSuccess('╨Ю╤В╨▓╨╡╤В ╨┐╨╛╨╗╤Г╤З╨╡╨╜!');
        } else {
            if (chatResult) {
                chatResult.innerHTML = `<div class="result error">тЭМ ╨Ю╤И╨╕╨▒╨║╨░: ${data.error}</div>`;
            }
            showError('╨Ю╤И╨╕╨▒╨║╨░ AI: ' + data.error);
        }
            
    } catch (error) {
        console.error('тЭМ ╨Ю╤И╨╕╨▒╨║╨░ AI ╤З╨░╤В╨░:', error);
        if (typingIndicator) typingIndicator.style.display = 'none';
        if (chatResult) {
            chatResult.innerHTML = `<div class="result error">тЭМ ╨Ю╤И╨╕╨▒╨║╨░: ${error.message}</div>`;
        }
        showError('╨Ю╤И╨╕╨▒╨║╨░ ╤Б╨╛╨╡╨┤╨╕╨╜╨╡╨╜╨╕╤П: ' + error.message);
    }
}

async function testAIChatStream(psychotype, provider, model, message) {
    const typingIndicator = document.getElementById('typingIndicator');
    const streamIndicator = document.getElementById('streamIndicator');
    const chatResult = document.getElementById('chatResult');
    
    if (typingIndicator) typingIndicator.style.display = 'none';
    if (streamIndicator) streamIndicator.style.display = 'block';
    if (chatResult) {
        chatResult.innerHTML = 
            '<div class="result streaming-active" id="streamResult"><strong>ЁЯТн ╨Ю╤В╨▓╨╡╤В:</strong> <span id="streamText"></span></div>';
    }
    
    const streamStartTime = Date.now();
    const streamText = document.getElementById('streamText');
    
    try {
        console.log('ЁЯУд ╨Ю╤В╨┐╤А╨░╨▓╨║╨░ ╨┐╨╛╤В╨╛╨║╨╛╨▓╨╛╨│╨╛ ╨╖╨░╨┐╤А╨╛╤Б╨░ ╨║ AI...', { psychotype, provider, model, message });
        
        const response = await fetch('/api/chat/ai/stream', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + window.currentToken
            },
            body: JSON.stringify({
                message: message,
                psychotype: psychotype,
                provider: provider,
                model: model
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `HTTP ╨╛╤И╨╕╨▒╨║╨░! ╤Б╤В╨░╤В╤Г╤Б: ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = '';
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            fullResponse += chunk;
            if (streamText) streamText.textContent = fullResponse;
            
            if (streamText) streamText.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        const streamEndTime = Date.now();
        const streamTime = streamEndTime - streamStartTime;
        
        const timingHTML = `
            <div class="timing">
                <strong>тП▒я╕П ╨Т╤А╨╡╨╝╤П ╨┐╨╛╤В╨╛╨║╨╛╨▓╨╛╨╣ ╨┐╨╡╤А╨╡╨┤╨░╤З╨╕:</strong>
                <div class="timing-grid">
                    <div class="timing-item">
                        <div class="timing-value">${streamTime}ms</div>
                        <div>╨Ю╨▒╤Й╨╡╨╡ ╨▓╤А╨╡╨╝╤П</div>
                    </div>
                </div>
            </div>
        `;
        
        const streamResult = document.getElementById('streamResult');
        if (streamResult) streamResult.innerHTML += timingHTML;
        
        showSuccess('╨Я╨╛╤В╨╛╨║╨╛╨▓╤Л╨╣ ╨╛╤В╨▓╨╡╤В ╨╖╨░╨▓╨╡╤А╤И╨╡╨╜!');
        
    } catch (error) {
        console.error('тЭМ ╨Ю╤И╨╕╨▒╨║╨░ ╨┐╨╛╤В╨╛╨║╨╛╨▓╨╛╨╣ ╨┐╨╡╤А╨╡╨┤╨░╤З╨╕:', error);
        if (chatResult) {
            chatResult.innerHTML = `<div class="result error">тЭМ ╨Ю╤И╨╕╨▒╨║╨░ ╨┐╨╛╤В╨╛╨║╨╛╨▓╨╛╨╣ ╨┐╨╡╤А╨╡╨┤╨░╤З╨╕: ${error.message}</div>`;
        }
        showError('╨Ю╤И╨╕╨▒╨║╨░ ╨┐╨╛╤В╨╛╨║╨╛╨▓╨╛╨╣ ╨┐╨╡╤А╨╡╨┤╨░╤З╨╕: ' + error.message);
    } finally {
        if (streamIndicator) streamIndicator.style.display = 'none';
    }
}

function displayRegularResult(data, clientTime) {
    const chatResult = document.getElementById('chatResult');
    if (!chatResult) return;
    
    let resultHTML = `
        <div class="result success">
            <div style="margin-bottom: 15px;">
                <strong>ЁЯТн ╨Ю╤В╨▓╨╡╤В:</strong> ${data.response}
            </div>
            <div style="color: #666; font-size: 14px;">
                <span class="psychotype-badge">${data.psychotype}</span>
                <span class="provider-badge">${data.provider}</span>
                <span class="model-badge">${data.model}</span>
            </div>
        </div>
    `;
    
    if (data.timing) {
        resultHTML += `
            <div class="timing">
                <strong>тП▒я╕П ╨Т╤А╨╡╨╝╤П ╨╛╤В╨▓╨╡╤В╨░:</strong>
                <div class="timing-grid">
                    <div class="timing-item">
                        <div class="timing-value">${data.timing.api_response_time || 'N/A'}ms</div>
                        <div>API</div>
                    </div>
                    <div class="timing-item">
                        <div class="timing-value">${data.timing.total_time || 'N/A'}ms</div>
                        <div>╨б╨╡╤А╨▓╨╡╤А</div>
                    </div>
                    <div class="timing-item">
                        <div class="timing-value">${clientTime}ms</div>
                        <div>╨Ъ╨╗╨╕╨╡╨╜╤В</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    chatResult.innerHTML = resultHTML;
}

// ╨Р╨▓╤В╨╛╨╝╨░╤В╨╕╤З╨╡╤Б╨║╨╕ ╨╖╨░╨│╤А╤Г╨╢╨░╨╡╨╝ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╤Л ╨┐╤А╨╕ ╨╖╨░╨│╤А╤Г╨╖╨║╨╡ ╤Б╤В╤А╨░╨╜╨╕╤Ж╤Л
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (window.currentToken) {
            window.loadProviders();
        }
    }, 1000);
});

// ╨д╤Г╨╜╨║╤Ж╨╕╤П ╨╖╨░╨│╤А╤Г╨╖╨║╨╕ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨╛╨▓
export async function loadProviders() {
    try {
        console.log('ЁЯФД ╨Ч╨░╨│╤А╤Г╨╖╨║╨░ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨╛╨▓...');
        const response = await fetch('/api/providers');
        const providers = await response.json();
        
        if (!response.ok) {
            throw new Error(providers.error || '╨Ю╤И╨╕╨▒╨║╨░ ╨╖╨░╨│╤А╤Г╨╖╨║╨╕ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨╛╨▓');
        }

        const providerSelect = document.getElementById('provider');
        const modelSelect = document.getElementById('model');
        
        // ╨Ю╤З╨╕╤Й╨░╨╡╨╝ ╤Б╨╡╨╗╨╡╨║╤В╤Л
        providerSelect.innerHTML = '';
        modelSelect.innerHTML = '';
        
        // ╨Ч╨░╨┐╨╛╨╗╨╜╤П╨╡╨╝ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╤Л
        providers.forEach(provider => {
            if (provider.enabled) {
                const option = document.createElement('option');
                option.value = provider.id;
                option.textContent = `${provider.name} ${provider.enabled ? 'тЬЕ' : 'тЭМ'}`;
                providerSelect.appendChild(option);
            }
        });
        
        // ╨Ю╨▒╨╜╨╛╨▓╨╗╤П╨╡╨╝ ╨╝╨╛╨┤╨╡╨╗╨╕ ╨┐╤А╨╕ ╨▓╤Л╨▒╨╛╤А╨╡ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨░
        providerSelect.addEventListener('change', updateModels);
        
        // ╨Ш╨╜╨╕╤Ж╨╕╨░╨╗╨╕╨╖╨╕╤А╤Г╨╡╨╝ ╨╝╨╛╨┤╨╡╨╗╨╕ ╨┤╨╗╤П ╨┐╨╡╤А╨▓╨╛╨│╨╛ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨░
        await updateModels();
        
        console.log('тЬЕ ╨Я╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╤Л ╨╖╨░╨│╤А╤Г╨╢╨╡╨╜╤Л:', providers);
        return providers;
    } catch (error) {
        console.error('тЭМ ╨Ю╤И╨╕╨▒╨║╨░ ╨╖╨░╨│╤А╤Г╨╖╨║╨╕ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨╛╨▓:', error);
        showError('╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╖╨░╨│╤А╤Г╨╖╨╕╤В╤М ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╤Л: ' + error.message);
    }
}

async function updateModels() {
    try {
        const providerSelect = document.getElementById('provider');
        const modelSelect = document.getElementById('model');
        const providers = await loadProvidersData();
        
        const selectedProvider = providers.find(p => p.id === providerSelect.value);
        
        if (!selectedProvider) return;
        
        // ╨Ю╤З╨╕╤Й╨░╨╡╨╝ ╨╝╨╛╨┤╨╡╨╗╨╕
        modelSelect.innerHTML = '';
        
        // ╨Ч╨░╨┐╨╛╨╗╨╜╤П╨╡╨╝ ╨╝╨╛╨┤╨╡╨╗╨╕ ╨┤╨╗╤П ╨▓╤Л╨▒╤А╨░╨╜╨╜╨╛╨│╨╛ ╨┐╤А╨╛╨▓╨░╨╣╨┤╨╡╤А╨░
        Object.entries(selectedProvider.models).forEach(([modelKey, modelInfo]) => {
            const option = document.createElement('option');
            option.value = modelKey;
            option.textContent = `${modelInfo.name} (${modelInfo.context} tokens)`;
            modelSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('тЭМ ╨Ю╤И╨╕╨▒╨║╨░ ╨╛╨▒╨╜╨╛╨▓╨╗╨╡╨╜╨╕╤П ╨╝╨╛╨┤╨╡╨╗╨╡╨╣:', error);
    }
}

async function loadProvidersData() {
    const response = await fetch('/api/providers');
    return await response.json();
}

// ╨Ф╨╡╨╗╨░╨╡╨╝ ╤Д╤Г╨╜╨║╤Ж╨╕╤О ╨│╨╗╨╛╨▒╨░╨╗╤М╨╜╨╛╨╣
window.loadProviders = loadProviders;
