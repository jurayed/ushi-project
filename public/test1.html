<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† –£—à–∏ - –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</title>
    <script src="/ngrok-fix.js"></script>
	<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .auth-section {
            margin-bottom: 30px;
        }
        
        .auth-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .user-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .hidden {
            display: none;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .tab-button {
            flex: 1;
            padding: 12px;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: #4facfe;
            color: white;
        }
        
        .control-group {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
        }
        
        .control-group h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        label {
            font-weight: 600;
            color: #555;
            min-width: 100px;
        }
        
        select, input[type="text"] {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
        }
        
        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .result-area {
            margin-top: 30px;
        }
        
        .typing {
            color: #6c757d;
            font-style: italic;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            display: none;
        }
        
        .stream-indicator {
            color: #4caf50;
            font-weight: bold;
            padding: 15px;
            background: #f8fff9;
            border-radius: 8px;
            text-align: center;
            display: none;
            border: 2px solid #4caf50;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { border-color: #4caf50; }
            50% { border-color: #81c784; }
            100% { border-color: #4caf50; }
        }
        
        .result {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .success {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .error {
            border-color: #dc3545;
            background: #fff8f8;
        }
        
        .streaming-active {
            border-color: #4caf50;
            animation: pulse 2s infinite;
        }
        
        .timing {
            background: #e9ecef;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .timing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .timing-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .timing-value {
            font-size: 18px;
            font-weight: bold;
            color: #4facfe;
        }
        
        .provider-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #4facfe;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .psychotype-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #28a745;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .model-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #ff9800;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .stream-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #4caf50;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† –£—à–∏ - –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h1>
            <p>–í—ã–≥–æ–≤–æ—Ä–∏—Å—å –∏ –ø–æ–ª—É—á–∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É</p>
        </div>
        
        <div class="content">
            <!-- –°–µ–∫—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
            <div id="authSection" class="auth-section">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="showTab('login')">–í—Ö–æ–¥</button>
                    <button class="tab-button" onclick="showTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>
                
                <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
                <div id="loginForm" class="auth-form">
                    <h3>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
                    <div class="form-group">
                        <label for="loginUsername">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                        <input type="text" id="loginUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à username">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">–ü–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å">
                    </div>
                    <button class="btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
                </div>
                
                <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
                <div id="registerForm" class="auth-form hidden">
                    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                    <div class="form-group">
                        <label for="regUsername">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                        <input type="text" id="regUsername" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ username">
                    </div>
                    <div class="form-group">
                        <label for="regEmail">Email:</label>
                        <input type="email" id="regEmail" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email">
                    </div>
                    <div class="form-group">
                        <label for="regPassword">–ü–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="regPassword" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                    </div>
                    <button class="btn-primary" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </div>
            </div>
            
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞) -->
            <div id="mainInterface" class="hidden">
                <div class="user-info">
                    <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="userName"></span>!</h3>
                    <button class="btn-secondary" onclick="logout()">–í—ã–π—Ç–∏</button>
                </div>
                
                <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–∞—Ç–∞ -->
                <div class="control-group">
                    <h3>üé≠ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞</h3>
                    
                    <div class="control-row">
                        <label for="provider">AI –ü—Ä–æ–≤–∞–π–¥–µ—Ä:</label>
                        <select id="provider">
                            <!-- –û–ø—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                        </select>
                    </div>
                    
                    <div class="control-row">
                        <label for="model">–ú–æ–¥–µ–ª—å:</label>
                        <select id="model">
                            <!-- –û–ø—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                        </select>
                    </div>
                    
                    <div class="control-row">
                        <label for="psychotype">–ü—Å–∏—Ö–æ—Ç–∏–ø:</label>
                        <select id="psychotype">
                            <option value="empath">–≠–º–ø–∞—Ç ü§ó</option>
                            <option value="optimist">–û–ø—Ç–∏–º–∏—Å—Ç üåü</option>
                            <option value="rational">–†–∞—Ü–∏–æ–Ω–∞–ª–∏—Å—Ç üß†</option>
                        </select>
                    </div>
                    
                    <div class="control-row">
                        <label for="messageInput">–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                        <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="useStreaming" checked>
                        <label for="useStreaming" style="min-width: auto; font-weight: normal;">
                            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫–æ–≤—É—é –ø–µ—Ä–µ–¥–∞—á—É (–±—ã—Å—Ç—Ä–µ–µ)
                        </label>
                    </div>
                </div>
                
                <div class="buttons">
				  <button class="btn-primary" onclick="testAIChat()">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ò–ò</button>
				  <button class="btn-secondary" onclick="loadProviders()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã</button>
				  <button class="btn-secondary" onclick="toggleEarRegistration()" id="earToggleButton">üéß –°—Ç–∞—Ç—å —Å–ª—É—à–∞—Ç–µ–ª–µ–º</button>
				  <button class="btn-primary" onclick="findLiveEar()">üë• –ù–∞–π—Ç–∏ –∂–∏–≤–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è</button>
				</div>			
				
                <div id="typingIndicator" class="typing">
                    ‚è≥ –ò–ò –ø–µ—á–∞—Ç–∞–µ—Ç –æ—Ç–≤–µ—Ç... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.
                </div>

                <div id="streamIndicator" class="stream-indicator">
                    üîÑ –ü–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∞–∫—Ç–∏–≤–Ω–∞...
                </div>
                
                <div class="result-area">
                    <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
                    <div id="chatResult"></div>
                </div>
				
				<div id="liveEarsSection" class="hidden">
				  <h3>üéß –°–∏—Å—Ç–µ–º–∞ –∂–∏–≤—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π</h3>
				  <div id="earsInfo"></div>
				  <div id="conversationSection" class="hidden">
					<h4>üí¨ –°–µ—Å—Å–∏—è —Å —Å–ª—É—à–∞—Ç–µ–ª–µ–º</h4>
					<div id="conversationMessages" style="height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"></div>
					<div class="control-row">
					  <input type="text" id="conversationMessageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
					  <button onclick="sendConversationMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
					</div>
					<button onclick="closeConversation()" class="btn-secondary">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
				  </div>
				</div>
            </div>
        </div>
    </div>

    <script>
    // ==================== GLOBAL VARIABLES ====================
    let currentUser = null;
    let currentToken = null;
    let availableProviders = [];
    let availableModels = {};
	let currentConversationId = null;
	let isEar = false;
	let socket = null;
    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
    });

    async function initializeApp() {
        showLoading('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
        
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
            const savedToken = localStorage.getItem('ushi_token');
            if (savedToken) {
                currentToken = savedToken;
                await checkAuth();
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
            await loadProviders();
            
            hideLoading();
            
        } catch (error) {
            hideLoading();
            showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
        }
    }

    // ==================== AUTHENTICATION FUNCTIONS ====================
    async function login() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;

        if (!validateAuthFields(username, password)) {
            return;
        }

        showLoading('–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É...');

        try {
            const response = await fetch('http://localhost:3000/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (response.ok) {
                currentToken = data.token;
                currentUser = data.user;
                localStorage.setItem('ushi_token', data.token);
                showMainInterface();
                showSuccess('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
            } else {
                showError('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (error) {
            showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    async function register() {
        const username = document.getElementById('regUsername').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const password = document.getElementById('regPassword').value;

        if (!validateRegFields(username, email, password)) {
            return;
        }

        showLoading('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...');

        try {
            const response = await fetch('http://localhost:3000/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, email, password })
            });

            const data = await response.json();

            if (response.ok) {
                showSuccess('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
                showTab('login');
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                document.getElementById('regUsername').value = '';
                document.getElementById('regEmail').value = '';
                document.getElementById('regPassword').value = '';
            } else {
                showError('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (error) {
            showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    async function checkAuth() {
        try {
            const response = await fetch('http://localhost:3000/api/profile', {
                headers: {
                    'Authorization': 'Bearer ' + currentToken
                }
            });

            if (response.ok) {
                currentUser = await response.json();
                showMainInterface();
                return true;
            } else {
                localStorage.removeItem('ushi_token');
                currentToken = null;
                return false;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
            return false;
        }
    }

    function logout() {
        currentUser = null;
        currentToken = null;
        localStorage.removeItem('ushi_token');
        showAuthInterface();
        showInfo('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
    }

    // ==================== UI MANAGEMENT ====================
    function showMainInterface() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('mainInterface').classList.remove('hidden');
        document.getElementById('userName').textContent = currentUser.username;
        
		// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Socket.IO
		socket = io();

		// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Socket.IO
		socket.on('connect', () => {
			console.log('Connected to server');
			// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω
			socket.emit('user_online', {
				userId: currentUser.id,
				userData: {
					username: currentUser.username,
					// –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ
				}
			});
		});

		socket.on('listener_registered', (data) => {
			isEar = true;
			document.getElementById('earToggleButton').textContent = 'üéß –ü–µ—Ä–µ—Å—Ç–∞—Ç—å –±—ã—Ç—å —Å–ª—É—à–∞—Ç–µ–ª–µ–º';
			showSuccess('–í—ã —Ç–µ–ø–µ—Ä—å —Å–ª—É—à–∞—Ç–µ–ª—å!');
		});

		socket.on('listener_unregistered', (data) => {
			isEar = false;
			document.getElementById('earToggleButton').textContent = 'üéß –°—Ç–∞—Ç—å —Å–ª—É—à–∞—Ç–µ–ª–µ–º';
			showSuccess('–í—ã –±–æ–ª—å—à–µ –Ω–µ —Å–ª—É—à–∞—Ç–µ–ª—å');
		});

		socket.on('error', (data) => {
			showError(data.message);
		});
		
        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        setTimeout(() => {
            document.getElementById('messageInput').focus();
        }, 100);
		
		document.getElementById('liveEarsSection').classList.remove('hidden');
		loadEarsInfo();
    }

    function showAuthInterface() {
        document.getElementById('authSection').classList.remove('hidden');
        document.getElementById('mainInterface').classList.add('hidden');
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
    }

    function showTab(tabName) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Ñ–æ—Ä–º—É
        if (tabName === 'login') {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        } else {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }
    }

    // ==================== CHAT FUNCTIONS ====================
    async function loadProviders() {
        try {
            const response = await fetch('http://localhost:3000/api/providers');
            
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤');
            }
            
            availableProviders = await response.json();
            
            const providerSelect = document.getElementById('provider');
            providerSelect.innerHTML = '';
            
            availableProviders.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider.id;
                option.textContent = `${provider.name} ${provider.enabled ? '‚úÖ' : '‚ùå'}`;
                option.disabled = !provider.enabled;
                providerSelect.appendChild(option);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–æ–¥–µ–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
                if (provider.enabled) {
                    availableModels[provider.id] = provider.models;
                }
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
            loadModels();
            
            console.log('‚úÖ –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∏ –º–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', availableProviders);
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤:', error);
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤');
        }
    }

    function loadModels() {
        const provider = document.getElementById('provider').value;
        const modelSelect = document.getElementById('model');
        modelSelect.innerHTML = '';
        
        if (availableModels[provider]) {
            Object.entries(availableModels[provider]).forEach(([modelKey, modelInfo]) => {
                const option = document.createElement('option');
                option.value = modelKey;
                option.textContent = `${modelInfo.name} (${modelInfo.context} tokens) - ${modelInfo.price}`;
                modelSelect.appendChild(option);
            });
        }
    }

	// ==================== —Ä–∞–±–æ—Ç–ê —Å —Å–ª—É—à–∞—Ç–µ–ª—è–º–∏ jurayed====================
	// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/—É–¥–∞–ª–µ–Ω–∏—è —Å–µ–±—è –∫–∞–∫ —Å–ª—É—à–∞—Ç–µ–ª—è
	async function toggleEarRegistration() {
    if (!currentUser || !socket) {
        showError('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
    }

    try {
        if (isEar) {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –æ—Ç–º–µ–Ω—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            socket.emit('unregister_listener', {
                userId: currentUser.id
            });
        } else {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            socket.emit('register_listener', {
                userId: currentUser.id,
                userData: {
                    username: currentUser.username,
                    psychotype: 'empath' // –∏–ª–∏ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å
                }
            });
        }
    } catch (error) {
        showError('–û—à–∏–±–∫–∞: ' + error.message);
    }
}

	// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∂–∏–≤–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è
	async function findLiveEar() {
	  try {
		const response = await fetch('/api/conversations/find', {
		  method: 'POST',
		  headers: {
			'Authorization': 'Bearer ' + currentToken
		  }
		});
		const data = await response.json();
		if (response.ok) {
		  currentConversationId = data.conversation_id;
		  document.getElementById('conversationSection').classList.remove('hidden');
		  loadConversationMessages();
		  showSuccess('–°–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞!');
		} else {
		  showError('–û—à–∏–±–∫–∞: ' + data.error);
		}
	  } catch (error) {
		showError('–û—à–∏–±–∫–∞: ' + error.message);
	  }
	}

	// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–µ—Å—Å–∏—é
	async function sendConversationMessage() {
	  const messageInput = document.getElementById('conversationMessageInput');
	  const message = messageInput.value.trim();
	  if (!message) return;

	  try {
		const response = await fetch(`/api/conversations/${currentConversationId}/message`, {
		  method: 'POST',
		  headers: {
			'Content-Type': 'application/json',
			'Authorization': 'Bearer ' + currentToken
		  },
		  body: JSON.stringify({ message })
		});
		if (response.ok) {
		  messageInput.value = '';
		  loadConversationMessages();
		} else {
		  showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
		}
	  } catch (error) {
		showError('–û—à–∏–±–∫–∞: ' + error.message);
	  }
	}

	// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–µ—Å—Å–∏–∏
	async function loadConversationMessages() {
	  try {
		const response = await fetch(`/api/conversations/${currentConversationId}/messages`, {
		  headers: {
			'Authorization': 'Bearer ' + currentToken
		  }
		});
		const messages = await response.json();
		const messagesContainer = document.getElementById('conversationMessages');
		messagesContainer.innerHTML = messages.map(msg => 
		  `<div><strong>${msg.username}:</strong> ${msg.message_text}</div>`
		).join('');
		messagesContainer.scrollTop = messagesContainer.scrollHeight;
	  } catch (error) {
		console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
	  }
	}

	// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Å–µ—Å—Å–∏–∏
	async function closeConversation() {
	  try {
		const response = await fetch(`/api/conversations/${currentConversationId}/close`, {
		  method: 'POST',
		  headers: {
			'Authorization': 'Bearer ' + currentToken
		  }
		});
		if (response.ok) {
		  currentConversationId = null;
		  document.getElementById('conversationSection').classList.add('hidden');
		  showSuccess('–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
		}
	  } catch (error) {
		showError('–û—à–∏–±–∫–∞: ' + error.message);
	  }
	}

	// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª—è—Ö
	async function loadEarsInfo() {
	  try {
		const response = await fetch('/api/ears/available', {
		  headers: {
			'Authorization': 'Bearer ' + currentToken
		  }
		});
		const data = await response.json();
		if (response.ok) {
		  document.getElementById('earsInfo').innerHTML = `–î–æ—Å—Ç—É–ø–Ω–æ —Å–ª—É—à–∞—Ç–µ–ª–µ–π: ${data.available_ears}`;
		}
	  } catch (error) {
		console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–ª—É—à–∞—Ç–µ–ª—è—Ö:', error);
	  }
	}
	
	// ==================== AI CHAT FUNCTIONS ====================
    async function testAIChat() {
        if (!currentToken) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
            return;
        }

        const psychotype = document.getElementById('psychotype').value;
        const provider = document.getElementById('provider').value;
        const model = document.getElementById('model').value;
        const message = document.getElementById('messageInput').value.trim();
        const useStreaming = document.getElementById('useStreaming').checked;

        if (!message) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
            return;
        }

        if (useStreaming) {
            await testAIChatStream(psychotype, provider, model, message);
        } else {
            await testAIChatRegular(psychotype, provider, model, message);
        }
    }

    async function testAIChatRegular(psychotype, provider, model, message) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        document.getElementById('typingIndicator').style.display = 'block';
        document.getElementById('streamIndicator').style.display = 'none';
        document.getElementById('chatResult').innerHTML = '';
        
        const clientStartTime = Date.now();
        
        try {
            const response = await fetch('http://localhost:3000/api/chat/ai', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + currentToken
                },
                body: JSON.stringify({
                    message: message,
                    psychotype: psychotype,
                    provider: provider,
                    model: model
                })
            });
            
            const clientEndTime = Date.now();
            const clientTime = clientEndTime - clientStartTime;
            
            if (!response.ok) {
                throw new Error(`HTTP –æ—à–∏–±–∫–∞! —Å—Ç–∞—Ç—É—Å: ${response.status}`);
            }
            
            const data = await response.json();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            document.getElementById('typingIndicator').style.display = 'none';
            
            if (data.success) {
                displayResult(data, clientTime, false);
            } else {
                document.getElementById('chatResult').innerHTML = 
                    `<div class="result error">‚ùå –û—à–∏–±–∫–∞: ${data.error}</div>`;
            }
                
        } catch (error) {
            document.getElementById('typingIndicator').style.display = 'none';
            document.getElementById('chatResult').innerHTML = 
                `<div class="result error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}</div>`;
        }
    }

    async function testAIChatStream(psychotype, provider, model, message) {
        document.getElementById('typingIndicator').style.display = 'none';
        document.getElementById('streamIndicator').style.display = 'block';
        document.getElementById('chatResult').innerHTML = 
            '<div class="result streaming-active" id="streamResult"><strong>üí≠ –û—Ç–≤–µ—Ç:</strong> <span id="streamText"></span></div>';
        
        const streamStartTime = Date.now();
        const streamText = document.getElementById('streamText');
        
        try {
            const response = await fetch('http://localhost:3000/api/chat/ai/stream', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + currentToken
                },
                body: JSON.stringify({
                    message: message,
                    psychotype: psychotype,
                    provider: provider,
                    model: model
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP –æ—à–∏–±–∫–∞! —Å—Ç–∞—Ç—É—Å: ${response.status}`);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                fullResponse += chunk;
                streamText.textContent = fullResponse;
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É
                streamText.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            const streamEndTime = Date.now();
            const streamTime = streamEndTime - streamStartTime;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏
            const timingHTML = `
                <div class="timing">
                    <strong>‚è±Ô∏è –í—Ä–µ–º—è –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏:</strong>
                    <div class="timing-grid">
                        <div class="timing-item">
                            <div class="timing-value">${streamTime}ms</div>
                            <div>–û–±—â–µ–µ –≤—Ä–µ–º—è</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('streamResult').innerHTML += timingHTML;
            
        } catch (error) {
            document.getElementById('chatResult').innerHTML = 
                `<div class="result error">‚ùå –û—à–∏–±–∫–∞ –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏: ${error.message}</div>`;
        } finally {
            document.getElementById('streamIndicator').style.display = 'none';
        }
    }

    function displayResult(data, clientTime, isStreaming) {
        const streamingBadge = isStreaming ? '<span class="stream-badge">STREAM</span>' : '';
        
        let resultHTML = `
            <div class="result success">
                <div style="margin-bottom: 15px;">
                    <strong>üí≠ –û—Ç–≤–µ—Ç:</strong> ${data.response}
                </div>
                <div style="color: #666; font-size: 14px;">
                    <span class="psychotype-badge">${data.psychotype}</span>
                    <span class="provider-badge">${data.provider}</span>
                    <span class="model-badge">${data.model}</span>
                    ${streamingBadge}
                </div>
            </div>
        `;
        
        if (!isStreaming) {
            resultHTML += `
                <div class="timing">
                    <strong>‚è±Ô∏è –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</strong>
                    <div class="timing-grid">
                        <div class="timing-item">
                            <div class="timing-value">${data.timing.api_response_time}ms</div>
                            <div>API</div>
                        </div>
                        <div class="timing-item">
                            <div class="timing-value">${data.timing.total_time}ms</div>
                            <div>–°–µ—Ä–≤–µ—Ä</div>
                        </div>
                        <div class="timing-item">
                            <div class="timing-value">${clientTime}ms</div>
                            <div>–ö–ª–∏–µ–Ω—Ç</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        document.getElementById('chatResult').innerHTML = resultHTML;
    }

    function showLiveEars() {
        alert('–°–∏—Å—Ç–µ–º–∞ "–ñ–∏–≤—ã—Ö –£—à–µ–π" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ!');
    }

    // ==================== VALIDATION FUNCTIONS ====================
    function validateAuthFields(username, password) {
        if (!username || !password) {
            showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return false;
        }
        
        if (username.length < 3) {
            showError('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤');
            return false;
        }
        
        return true;
    }

    function validateRegFields(username, email, password) {
        if (!username || !email || !password) {
            showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return false;
        }
        
        if (username.length < 3) {
            showError('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤');
            return false;
        }
        
        if (password.length < 6) {
            showError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤');
            return false;
        }
        
        if (!validateEmail(email)) {
            showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å');
            return false;
        }
        
        return true;
    }

    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    // ==================== UTILITY FUNCTIONS ====================
    function showLoading(message = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫—Ä–∞—Å–∏–≤—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        console.log('Loading:', message);
    }

    function hideLoading() {
        // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    }

    function showError(message) {
        alert('‚ùå ' + message);
    }

    function showSuccess(message) {
        alert('‚úÖ ' + message);
    }

    function showInfo(message) {
        alert('‚ÑπÔ∏è ' + message);
    }

    // ==================== EVENT LISTENERS ====================
    document.addEventListener('DOMContentLoaded', function() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è Enter –≤ —Ñ–æ—Ä–º–∞—Ö
        document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
        
        document.getElementById('regPassword')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') register();
        });
        
        document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') testAIChat();
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        document.getElementById('provider')?.addEventListener('change', loadModels);
    });
</script>
<script src="/socket.io/socket.io.js"></script>
</body>
</html>