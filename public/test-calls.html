<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∑–≤–æ–Ω–∫–æ–≤ - –£—à–∏</title>
    <style>
        .hidden { display: none !important; }
        .call-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .call-modal {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .video-container {
            position: relative;
            width: 640px;
            height: 480px;
        }
        #remoteVideo {
            width: 100%;
            height: 100%;
            background: #000;
        }
        #localVideo {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 160px;
            height: 120px;
            border: 2px solid white;
            border-radius: 5px;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>üß† –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤ –∏ –∞—É–¥–∏–æ—Å–æ–æ–±—â–µ–Ω–∏–π</h1>
    
    <div id="authSection">
        <h3>–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
        <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()" class="btn-primary">–í–æ–π—Ç–∏</button>
    </div>
    
    <div id="mainInterface" class="hidden">
        <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="userName"></span>!</h3>
        <button onclick="logout()" class="btn-secondary">–í—ã–π—Ç–∏</button>
        
        <div style="margin: 20px 0;">
            <h4>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤:</h4>
            <button onclick="startAudioCall()" class="btn-primary">üìû –ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫ (—Å–µ–±–µ)</button>
            <button onclick="startVideoCall()" class="btn-primary">üé• –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ (—Å–µ–±–µ)</button>
            <button onclick="startAudioMessage()" class="btn-secondary">üé§ –ê—É–¥–∏–æ—Å–æ–æ–±—â–µ–Ω–∏–µ (5 —Å–µ–∫)</button>
        </div>
        
        <div>
            <p><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong></p>
            <p>1. –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö (Chrome, Firefox)</p>
            <p>2. –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</p>
            <p>3. –ù–∞–∂–º–∏—Ç–µ "–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫" –≤ –æ–¥–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ</p>
            <p>4. –í–æ –≤—Ç–æ—Ä–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ—è–≤–∏—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–≤–æ–Ω–∫–µ</p>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/RecordRTC/5.6.2/RecordRTC.js"></script>
	<script type="module">
		import { showError, showSuccess } from './js/ui.js';
		import { setupWebRTCListeners } from './js/webrtc.js';

		// –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏
		window.showError = showError;
		window.showSuccess = showSuccess;
		
		window.showMainInterface = function() {
			document.getElementById('authSection').classList.add('hidden');
			document.getElementById('mainInterface').classList.remove('hidden');
		};
		
		window.showAuthInterface = function() {
			document.getElementById('authSection').classList.remove('hidden');
			document.getElementById('mainInterface').classList.add('hidden');
		};

		// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è login
		window.login = async function() {
			const username = document.getElementById('loginUsername').value;
			const password = document.getElementById('loginPassword').value;
			
			if (!username || !password) {
				alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å');
				return;
			}
			
			try {
				const response = await fetch('/api/login', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ username, password })
				});
				
				const data = await response.json();
				
				if (response.ok) {
					window.currentUser = data.user;
					window.currentToken = data.token;
					document.getElementById('userName').textContent = data.user.username;
					showMainInterface();
					
					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Socket.IO
					window.socket = io();
					window.socket.on('connect', () => {
						console.log('Socket –ø–æ–¥–∫–ª—é—á–µ–Ω');
						setupWebRTCListeners();
					});
					
				} else {
					alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + data.error);
				}
			} catch (error) {
				alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
			}
		};
		
		// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è logout
		window.logout = function() {
			window.currentUser = null;
			window.currentToken = null;
			if (window.socket) {
				window.socket.disconnect();
				window.socket = null;
			}
			showAuthInterface();
		};
	</script>
</body>
</html>