<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ushi Project</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
</head>
<body>

    <!-- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø -->
    <div id="authSection" class="container" style="justify-content: center;">
        <div class="glass-panel auth-box">
            <h1 class="logo" style="margin-bottom: 30px;">üëÇ Ushi Project</h1>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="showTab('login')">–í—Ö–æ–¥</div>
                <div class="auth-tab" onclick="showTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            </div>

            <div id="loginForm">
                <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="btn btn-primary w-100" onclick="login()">–í–æ–π—Ç–∏</button>
            </div>

            <div id="registerForm" class="hidden">
                <input type="text" id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="email" id="regEmail" placeholder="Email">
                <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="btn btn-primary w-100" onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
    <div id="mainInterface" class="container hidden">
        
        <!-- –®–∞–ø–∫–∞ -->
        <div class="top-bar glass-panel">
            <div class="logo">üëÇ Ushi</div>
            <div id="userInfoPanel">
                <button class="btn btn-secondary" onclick="logout()">–í—ã—Ö–æ–¥ <i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <!-- –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ -->
        <div id="modeSelectionSection">
            <div class="mode-cards">
                <div class="glass-panel mode-card" onclick="switchToMode('ai')">
                    <i class="fas fa-robot fa-3x"></i>
                    <h2>–ß–∞—Ç —Å AI</h2>
                    <p>–£–º–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–æ–ª–æ—Å–∞</p>
                </div>
                <div class="glass-panel mode-card" onclick="switchToMode('live')">
                    <i class="fas fa-users fa-3x"></i>
                    <h2>–õ—é–¥–∏</h2>
                    <p>–ù–∞–π–¥–∏ —Å–ª—É—à–∞—Ç–µ–ª—è –∏–ª–∏ —Å—Ç–∞–Ω—å –∏–º</p>
                </div>
            </div>
        </div>

        <!-- –°–ï–ö–¶–ò–Ø AI -->
        <div id="aiSection" class="chat-layout glass-panel hidden">
            <!-- –ê–í–ê–¢–ê–† (–°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
			<div id="avatarContainer" class="hidden" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center;">
				<canvas id="avatarCanvas" width="300" height="300"></canvas>
				<div id="liveStatus" style="color: white; margin-top: 20px; font-size: 1.2rem;">–°–ª—É—à–∞—é...</div>
				<button class="btn btn-danger rounded-circle" style="width: 60px; height: 60px; margin-top: 30px;" onclick="toggleLiveMode()">
					<i class="fas fa-stop"></i>
				</button>
			</div>			
			<!-- –®–∞–ø–∫–∞ —á–∞—Ç–∞ -->
            <div class="chat-header">
                <button class="btn-icon" onclick="showModeSelection()"><i class="fas fa-arrow-left"></i></button>
                <h3>AI Companion</h3>
				<!-- –ö–ù–û–ü–ö–ê –ñ–ò–í–û–ì–û –†–ï–ñ–ò–ú–ê -->
				<button id="btnLiveMode" class="btn-icon" style="color: #00cec9;" onclick="toggleLiveMode()" title="–ñ–∏–≤–æ–π —Ä–∞–∑–≥–æ–≤–æ—Ä">
					<i class="fas fa-headset"></i>
				</button>
				<!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
                <button class="btn-icon" onclick="toggleAiSettings(true)"><i class="fas fa-cog"></i></button>
            </div>

            <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div id="aiChatContainer" class="messages-area">
                <div style="text-align:center; opacity:0.5; margin-top:50px;">
                    –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –∫–Ω–æ–ø–∫–µ ‚öôÔ∏è
                </div>
            </div>
            <div id="typingIndicator" class="hidden" style="padding: 0 20px; font-size: 0.8rem; opacity: 0.7;">
                AI –ø–µ—á–∞—Ç–∞–µ—Ç...
            </div>

			<!-- ... (–ß–∞—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä) ... -->

			<!-- –ü–ê–ù–ï–õ–¨ –ó–ê–î–ï–†–ñ–ö–ò (–°–Ω–∏–∑—É) -->
			<div id="latencyPanel" class="hidden" style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; color: #aaa; pointer-events: none;">
				STT: <span id="latStt">-</span>ms | LLM: <span id="latLlm">-</span>ms | TTS: <span id="latTts">-</span>ms
			</div>
            <!-- –í–≤–æ–¥ -->
            <div class="input-area">
                <button id="recordButton" class="btn-icon"><i class="fas fa-microphone"></i></button>
                <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="btn-icon text-primary" onclick="testAIChat()"><i class="fas fa-paper-plane"></i></button>
            </div>

            <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ù–ê–°–¢–†–û–ï–ö -->
            <div id="aiSettingsModal" class="modal-overlay hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞</h3>
                        <span class="close-modal" onclick="toggleAiSettings(false)">&times;</span>
                    </div>
                    
                    <label>–ü—Ä–æ–≤–∞–π–¥–µ—Ä:</label>
                    <select id="provider"></select>
                    
                    <label>–ú–æ–¥–µ–ª—å:</label>
                    <select id="model"></select>
                    
                    <label>–•–∞—Ä–∞–∫—Ç–µ—Ä –±–æ—Ç–∞:</label>
                    <select id="psychotype">
                        <option value="empath">–≠–º–ø–∞—Ç (–ú—è–≥–∫–∏–π, –ø–æ–Ω–∏–º–∞—é—â–∏–π)</option>
                        <option value="rational">–†–∞—Ü–∏–æ–Ω–∞–ª–∏—Å—Ç (–õ–æ–≥–∏—á–Ω—ã–π, —á–µ—Ç–∫–∏–π)</option>
                        <option value="optimist">–û–ø—Ç–∏–º–∏—Å—Ç (–í–µ—Å–µ–ª—ã–π, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π)</option>
                    </select>

                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="useStreaming" checked>
                        <label for="useStreaming">–ü–µ—á–∞—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ (Stream)</label>
                    </div>

                    <button class="btn btn-primary w-100" style="margin-top: 20px;" onclick="toggleAiSettings(false)">–ì–æ—Ç–æ–≤–æ</button>
                </div>
            </div>
        </div>

        <!-- –°–ï–ö–¶–ò–Ø LIVE -->
        <div id="liveSection" class="container hidden">
             <!-- –°–ø–∏—Å–æ–∫ —Å–ª—É—à–∞—Ç–µ–ª–µ–π -->
             <div id="listenersPanel">
                <div style="display:flex; justify-content:between; align-items:center; margin-bottom:20px;">
                    <button class="btn-icon" onclick="showModeSelection()"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                    <h2>–ñ–∏–≤–æ–µ –æ–±—â–µ–Ω–∏–µ</h2>
                    <button id="earToggleButton" class="btn btn-primary" onclick="toggleEarRegistration()">üéß –°—Ç–∞—Ç—å —Å–ª—É—à–∞—Ç–µ–ª–µ–º</button>
                </div>
                
                <div id="listenersListContainer" class="listeners-list"></div>
            </div>

            <!-- –ß–∞—Ç —Å —á–µ–ª–æ–≤–µ–∫–æ–º -->
            <div id="conversationSection" class="chat-layout glass-panel hidden">
                <div class="chat-header">
                    <button class="btn-icon" onclick="closeConversation()"><i class="fas fa-times"></i></button>
                    <h3 id="conversationPartner">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</h3>
                    <div>
                        <button class="btn-icon" onclick="startAudioCall()"><i class="fas fa-phone"></i></button>
                        <button class="btn-icon" onclick="startVideoCall()"><i class="fas fa-video"></i></button>
                    </div>
                </div>

                <div id="conversationMessages" class="messages-area"></div>

                <div class="input-area">
                    <button id="conversationRecordButton" class="btn-icon" onclick="startConversationAudio()"><i class="fas fa-microphone"></i></button>
                    <button id="conversationStopButton" class="btn-icon text-danger hidden" onclick="stopConversationAudio()"><i class="fas fa-stop"></i></button>
                    
                    <input type="text" id="conversationMessageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                    <button class="btn-icon text-primary" onclick="sendConversationMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

    </div>

    <!-- –°–ö–†–ò–ü–¢–´ -->
    <script type="module" src="js/utils.js"></script>
    <script type="module" src="js/ui.js"></script>
    <script type="module" src="js/auth.js"></script>
    <script type="module" src="js/webrtc.js"></script>
    <script type="module" src="js/ai-chat.js"></script>
    <script type="module" src="js/live-listeners.js"></script>
    <script type="module" src="js/socket-client.js"></script>
    <script type="module" src="js/app.js"></script>

</body>
</html>
